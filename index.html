<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Temp Number Viewer</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* small custom tweaks */
    .card-shadow { box-shadow: 0 6px 18px rgba(15,23,42,0.06); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">

  <div class="max-w-3xl mx-auto p-4">
    <header class="flex items-center justify-between mb-4">
      <div>
        <h1 class="text-2xl font-bold">Temp Number Viewer</h1>
        <p class="text-sm text-slate-500">Free public temp numbers (multi-source) — demo UI</p>
      </div>
      <div class="text-right">
        <button id="refreshBtn" class="bg-sky-600 text-white px-3 py-1 rounded shadow-sm text-sm">Refresh</button>
      </div>
    </header>

    <!-- Controls -->
    <section class="bg-white p-4 rounded card-shadow mb-4">
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
        <div class="sm:col-span-2">
          <label class="text-sm text-slate-600">Country slug</label>
          <input id="countryInput" type="text" value="united-states" class="mt-1 w-full border rounded px-3 py-2" />
          <p class="text-xs text-slate-400 mt-1">উদাহরণ: <span class="mono">united-states</span>, <span class="mono">usa</span>, <span class="mono">bangladesh</span></p>
        </div>

        <div class="flex items-end">
          <button id="loadBtn" class="w-full bg-emerald-600 text-white px-4 py-2 rounded">Load Numbers</button>
        </div>
      </div>

      <div id="status" class="mt-3 text-sm text-slate-500"></div>
    </section>

    <!-- Numbers list -->
    <section id="numbersSection" class="space-y-3">
      <!-- cards injected here -->
    </section>

    <footer class="mt-8 text-xs text-slate-500 text-center">
      Built for demo • Replace <span class="mono">apiBase</span> with your backend URL
    </footer>
  </div>

  <!-- SMS Modal -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-40">
    <div class="bg-white w-[95%] sm:w-3/4 max-h-[80vh] overflow-auto rounded-lg p-4">
      <div class="flex justify-between items-center mb-3">
        <h3 id="modalTitle" class="text-lg font-semibold">Messages</h3>
        <button id="closeModal" class="text-slate-500 hover:text-slate-700">Close</button>
      </div>
      <div id="modalBody" class="space-y-2 text-sm text-slate-700">
        <!-- messages -->
      </div>
    </div>
  </div>

  <script>
    // ====== IMPORTANT ======
    // Replace this with your deployed backend URL (no trailing slash).
    // Example: const apiBase = "https://your-backend.vercel.app";
    const apiBase = "YOUR_BACKEND_URL";

    // Example endpoints used by this UI:
    // GET `${apiBase}/api/numbers?country=${slug}`
    // GET `${apiBase}/api/messages?source=${source}&id=${id}`

    const loadBtn = document.getElementById('loadBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const countryInput = document.getElementById('countryInput');
    const statusEl = document.getElementById('status');
    const numbersSection = document.getElementById('numbersSection');
    const modal = document.getElementById('modal');
    const modalBody = document.getElementById('modalBody');
    const modalTitle = document.getElementById('modalTitle');
    const closeModal = document.getElementById('closeModal');

    function setStatus(text, isError = false) {
      statusEl.textContent = text;
      statusEl.className = isError ? 'mt-3 text-sm text-red-600' : 'mt-3 text-sm text-slate-500';
    }

    function clearNumbers() {
      numbersSection.innerHTML = '';
    }

    async function fetchNumbers() {
      const slug = (countryInput.value || '').trim() || 'united-states';
      if (!apiBase || apiBase === "YOUR_BACKEND_URL") {
        setStatus("Please set apiBase in the script to your backend URL.", true);
        return;
      }
      setStatus("Loading numbers...");
      clearNumbers();
      try {
        const res = await fetch(`${apiBase}/api/numbers?country=${encodeURIComponent(slug)}`);
        if (!res.ok) throw new Error("Network error: " + res.status);
        const list = await res.json();

        // Expecting array of items: { source, number, id, link }
        if (!Array.isArray(list) || list.length === 0) {
          setStatus("No numbers found for this country / source.", true);
          return;
        }

        setStatus(`Loaded ${list.length} numbers (showing latest).`);
        renderNumbers(list);
      } catch (err) {
        console.error(err);
        setStatus("Failed to load numbers: " + err.message, true);
      }
    }

    function renderNumbers(list) {
      numbersSection.innerHTML = ''; // reset
      // Group by source for nicer display (optional)
      const grouped = {};
      list.forEach(item => {
        const s = item.source || 'unknown';
        if (!grouped[s]) grouped[s] = [];
        grouped[s].push(item);
      });

      Object.keys(grouped).forEach(source => {
        const block = document.createElement('div');
        block.className = 'bg-white p-3 rounded card-shadow';
        block.innerHTML = `<div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-3">
              <span class="inline-block px-2 py-1 bg-slate-100 rounded text-xs text-slate-600 mono">${source}</span>
              <h4 class="text-sm font-semibold">Source: ${source}</h4>
            </div>
            <div class="text-xs text-slate-400">${grouped[source].length} numbers</div>
          </div>
          <div class="grid gap-2">` + grouped[source].slice(0, 20).map(item => {
            const num = item.number || item.id || '—';
            const id = encodeURIComponent(item.id || item.number || num);
            return `<div class="flex items-center justify-between p-2 border rounded">
              <div>
                <div class="text-sm font-medium">${num}</div>
                <div class="text-xs text-slate-400">${item.link ? `<a href="${item.link}" target="_blank" class="underline">Source link</a>` : ''}</div>
              </div>
              <div class="flex gap-2">
                <button data-source="${source}" data-id="${id}" class="viewBtn bg-sky-600 text-white px-2 py-1 rounded text-xs">View SMS</button>
              </div>
            </div>`;
          }).join('') + `</div>`;
        numbersSection.appendChild(block);
      });

      // Attach view handlers
      document.querySelectorAll('.viewBtn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const src = btn.getAttribute('data-source');
          const id = decodeURIComponent(btn.getAttribute('data-id'));
          await showMessages(src, id);
        });
      });
    }

    async function showMessages(source, id) {
      if (!apiBase || apiBase === "YOUR_BACKEND_URL") {
        setStatus("Please set apiBase in the script to your backend URL.", true);
        return;
      }
      modalBody.innerHTML = `<div class="text-sm text-slate-500">Loading messages...</div>`;
      modalTitle.textContent = `Messages — ${source} / ${id}`;
      modal.classList.remove('hidden');
      modal.classList.add('flex');

      try {
        const res = await fetch(`${apiBase}/api/messages?source=${encodeURIComponent(source)}&id=${encodeURIComponent(id)}`);
        if (!res.ok) throw new Error("Network error: " + res.status);
        const msgs = await res.json();

        if (!Array.isArray(msgs) || msgs.length === 0) {
          modalBody.innerHTML = `<div class="text-sm text-slate-500">No messages found.</div>`;
          return;
        }

        modalBody.innerHTML = msgs.map(m => {
          const from = m.from || m.sender || 'Unknown';
          const text = (m.msg || m.text || m.message || '').replace(/</g,'&lt;');
          const time = m.time || m.date || m.t || '';
          return `<div class="p-2 border rounded">
                    <div class="text-xs text-slate-400 mb-1">${from} • <span class="mono">${time}</span></div>
                    <div class="text-sm">${text}</div>
                  </div>`;
        }).join('');
      } catch (err) {
        console.error(err);
        modalBody.innerHTML = `<div class="text-sm text-red-600">Failed to load messages: ${err.message}</div>`;
      }
    }

    // close modal
    closeModal.addEventListener('click', () => {
      modal.classList.remove('flex');
      modal.classList.add('hidden');
    });
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.remove('flex');
        modal.classList.add('hidden');
      }
    });

    // buttons
    loadBtn.addEventListener('click', fetchNumbers);
    refreshBtn.addEventListener('click', fetchNumbers);

    // optional: auto load on open
    // window.addEventListener('load', fetchNumbers);
  </script>
</body>
</html>
